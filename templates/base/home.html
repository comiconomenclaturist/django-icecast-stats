{% extends 'base/index.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}

<script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
<script src="{% static 'js/moment.js' %}"></script>
<script src="{% static 'js/libs/chartjs/dist/chart.js' %}"></script>
<script src="{% static 'js/libs/daterangepicker/daterangepicker.js' %}"></script>
<script src="{% static 'js/global.js' %}"></script>
<script
	src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<link rel="stylesheet" type="text/css" href="{% static 'js/libs/daterangepicker/daterangepicker.css' %}">

<div class="header">
	<div class="item">
		<h1><a href="/">Resonance Streaming Stats</a></h1>
	</div>
	<div class="item">
		<form method="GET" action="/">
			{% for field in form.hidden_fields %}
			{{ field }}
			{% endfor %}
			<div>
				{% for field in form.visible_fields %}
				<div class="cell">
					<label>{{ field.label }}</label>
					<div class="{{ field.field.widget.input_type }}">
						{{ field }}
						{% if field.field.widget.input_type == "select" %}
						<span class="select-icon">&#9660;</span>
						{% endif %}
					</div>
				</div>
				{% if forloop.counter == 4 %}
			</div>
			<div>
				{% endif %}
				{% endfor %}
			</div>
		</form>
	</div>
	<div class="item">
		<div class="info">
			<div class="legend-container">
				<div id="legend"></div>
			</div>
			<div>
				<div id="live"></div>
				<p id="restart" class="upper">Restart streams</p>
				<p class="upper"><a href="/logout/?next=/">Log out</a></p>
			</div>
		</div>
	</div>
</div>

<div class="container">
	<div class="cell">
		<div class="canvas"><canvas id="listenerCount"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
	<div class="cell">
		<div class="canvas"><canvas id="listenerHours"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
	<div class="cell">
		<div class="canvas"><canvas id="browser"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
	<div class="cell">
		<div class="canvas"><canvas id="countries"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
	<div class="cell">
		<div class="canvas"><canvas id="referer"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
	<div class="cell">
		<div class="canvas"><canvas id="sources"></canvas></div>
		<div class="overlay">
			<div class="loader"></div>
		</div>
	</div>
</div>

<script type="text/javascript">
	var period = '{{request.GET.period}}' || '{{min_date}}' + ' - ' + '{{max_date}}';
	var start = period.split(' - ')[0];
	var end = period.split(' - ')[1];
	var countTotals = [];

	$('#id_datepicker').daterangepicker({
		showDropdowns: true,
		maxSpan: {
			"years": 10,
		},
		timePicker: true,
		timePickerIncrement: 60,
		locale: {
			format: 'YYYY/MM/DD HH:mm'
		},
		ranges: {
			'Today': [moment().startOf('day'), moment()],
			'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().startOf('day')],
			'Last 7 Days': [moment().subtract(7, 'days').startOf('day'), moment().startOf('day')],
			'Last 30 Days': [moment().subtract(30, 'days').startOf('day'), moment().startOf('day')],
			'This Month': [moment().startOf('month'), moment().add(1, 'month').startOf('month')],
			'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().startOf('month')],
			'This Month Last Year': [moment().startOf('month').subtract(1, 'year'), moment().subtract(1, 'year')],
			'This Year': [moment().startOf('year'), moment()],
			'This Year Last Year': [moment().startOf('year').subtract(1, 'year'), moment().subtract(1, 'year')],
		},
		alwaysShowCalendars: true,
		startDate: period.split(' - ')[0],
		endDate: period.split(' - ')[1],
		minDate: '{{min_date}}',
		maxDate: '{{max_date}}',
	}, function (start, end, label) {
		$('#id_period_0').val(start.format());
		$('#id_period_1').val(end.format());
		getData();
	});
	$('#id_datepicker').on('show.daterangepicker', function (e, datepicker) {
		$(datepicker.container).find('.minuteselect').hide();
	});

	$('input[name^="timepicker"]').daterangepicker({
		singleDatePicker: true,
		timePicker: true,
		timePickerIncrement: 15,
		timePicker24Hour: false,
		locale: {
			format: 'HH:mm'
		},
	})
	$('input[name^="timepicker"]').on('show.daterangepicker', function (e, datepicker) {
		$(datepicker.container).find('.calendar-table').hide();
	});

	var defaultLegendClickHandler = Chart.defaults.plugins.legend.onClick;

	var newLegendClickHandler = function (e, legendItem) {
		defaultLegendClickHandler.call(this, e, legendItem);
		updateTitle(this.chart);
	}

	function legendClickCallback(event) {
		event = event || window.event;
		var target = event.target || event.srcElement;

		while (target.nodeName !== 'LI') {
			target = target.parentElement;
		}
		var parent = target.parentElement;
		var index = Array.prototype.slice.call(parent.children).indexOf(target);

		$.each([listenerCountChart, listenerHoursChart], function (i, chart) {
			var meta = chart.getDatasetMeta(index);
			if (meta.hidden === null) {
				meta.hidden = !chart.data.datasets[index].hidden;
				target.classList.add('hidden');
			} else {
				target.classList.remove('hidden');
				meta.hidden = null;
			}
			updateTitle(chart);
			chart.update();
		});
	}

	function graphClickEvent(event, array) {
		if (array[0]) {
			var index = array[0]._index;
			var start = new Date(array[0]._xScale._timestamps.data[index]);
			if (index == (array[0]._xScale._timestamps.data.length - 1)) {
				var end = $('#id_datepicker').data('daterangepicker').endDate._d
			} else {
				var end = new Date(array[0]._xScale._timestamps.data[index + 1]);
			}
			if (end - start > 900000) { // 15 minutes minimum interval
				$('#id_datepicker').data('daterangepicker').setStartDate(start);
				$('#id_datepicker').data('daterangepicker').setEndDate(end);
				$('.applyBtn')[0].click();
			}
		}
	}

	const getOrCreateLegendList = (chart, id) => {
		const legendContainer = document.getElementById(id);
		let listContainer = legendContainer.querySelector('ul');

		if (!listContainer) {
			listContainer = document.createElement('ul');
			listContainer.style.display = 'flex';
			listContainer.style.flexDirection = 'row';

			legendContainer.appendChild(listContainer);
		}

		return listContainer;
	};

	const htmlLegendPlugin = {
		id: 'htmlLegend',
		afterUpdate(chart, args, options) {
			const ul = getOrCreateLegendList(chart, options.containerID);

			// Remove old legend items
			while (ul.firstChild) {
				ul.firstChild.remove();
			}

			// Reuse the built-in legendItems generator
			const items = chart.options.plugins.legend.labels.generateLabels(chart);

			items.forEach(item => {
				const li = document.createElement('li');
				li.style.alignItems = 'center';
				li.style.cursor = 'pointer';
				li.style.display = 'flex';
				li.style.flexDirection = 'row';
				li.style.marginLeft = '10px';

				li.onclick = () => {
					const { type } = chart.config;
					if (type === 'pie' || type === 'doughnut') {
						// Pie and doughnut charts only have a single dataset and visibility is per item
						chart.toggleDataVisibility(item.index);
					} else {
						chart.setDatasetVisibility(item.datasetIndex, !chart.isDatasetVisible(item.datasetIndex));
					}
					chart.update();
				};

				// Color box
				const boxSpan = document.createElement('span');
				boxSpan.style.background = item.fillStyle;
				boxSpan.style.borderColor = item.strokeStyle;
				boxSpan.style.borderWidth = item.lineWidth + 'px';
				boxSpan.style.display = 'inline-block';
				boxSpan.style.height = '20px';
				boxSpan.style.marginRight = '10px';
				boxSpan.style.width = '20px';

				// Text
				const textContainer = document.createElement('p');
				textContainer.style.color = item.fontColor;
				textContainer.style.margin = 0;
				textContainer.style.padding = 0;
				textContainer.style.textDecoration = item.hidden ? 'line-through' : '';

				const text = document.createTextNode(item.text);
				textContainer.appendChild(text);

				li.appendChild(boxSpan);
				li.appendChild(textContainer);
				ul.appendChild(li);
			});
		}
	};

	var listenerCountId = document.getElementById('listenerCount').getContext('2d');
	var listenerCountChart = new Chart(listenerCountId, {
		type: 'bar',
		data: {
			datasets: [],
		},
		options: {
			legend: {
				onClick: newLegendClickHandler, // for title totals
			},
			plugins: {
				title: {
					text: 'Listener count',
				},
				htmlLegend: {
					// ID of the container to put the legend in
					containerID: 'legend',
				},
				legend: {
					display: false,
				}
			},
			tooltips: {
				mode: 'x',
				callbacks: {
					title: function (tooltipItem, data) {
						times = new Set(data.datasets[0].data.map(function (e) { return e.x.toLocaleTimeString() }));
						if (times.size > 1) {
							return tooltipItem[0].xLabel;
						} else {
							return tooltipItem[0].xLabel.split('–')[0];
						}
					},
					afterLabel: function (tooltipItem, data) {
						window.total = 0;
						for (i = 0; i < data.datasets.length; i++) {
							window.total += parseFloat(data.datasets[i].data[tooltipItem.index].y)
						}
					},
					footer: function () {
						return 'Total: ' + window.total;
					}
				},
			},
			scales: {
				x: {
					type: 'time',
					time: {
						tooltipFormat: 'do MMM, yyyy – h:mma',
					},
					stacked: true,
					offset: true
				},
				y: {
					stacked: true,
					ticks: {
						beginAtZero: true,
						userCallback: function (label, index, labels) {
							if (Math.floor(label) === label) {
								return label;
							}
						},
					},
				}
			},
			hover: {
				onHover: function (e, el) {
					$('#listenerCount').css("cursor", el[0] ? "pointer" : "default");
				}
			},
			onClick: graphClickEvent,
			// animation: {
			// 	onComplete: function(tooltipItem, data) {
			// 		var chartInstance = this.chart;
			// 		var ctx = chartInstance.ctx;
			// 		var height = chartInstance.controller.boxes[0].maxHeight;
			// 		ctx.save();
			// 		ctx.font = '10px Verdana';
			// 		ctx.fillStyle = '#222';
			// 		ctx.textAlign = 'right'; 
			// 		ctx.rotate(90 * Math.PI / 180); // 90 degree rotation
			// 		Chart.helpers.each(this.data.datasets.forEach(function (dataset, i) {
			// 			var meta = chartInstance.controller.getDatasetMeta(i);
			// 			var total = 0;
			// 			Chart.helpers.each(meta.data.forEach(function (bar, index) {
			// 				total += dataset.data[index].y;
			// 				ctx.fillText(dataset.data[index].y, (height + 30), ((bar._model.x * -1) + 4));
			// 			}), this)
			// 		}), this);
			// 		ctx.restore();
			// 	}
			// }
		},
		plugins: [htmlLegendPlugin],
	});

	var listenerHoursId = document.getElementById('listenerHours').getContext('2d');
	var listenerHoursChart = new Chart(listenerHoursId, {
		type: 'bar',
		data: {
			datasets: [],
		},
		options: {
			legend: {
				onClick: newLegendClickHandler,
			},
			plugins: {
				title: {
					text: 'Listener hours',
				},
				htmlLegend: {
					// ID of the container to put the legend in
					containerID: 'legend',
				},
				legend: {
					display: false,
				}
			},
			tooltips: {
				mode: 'x',
				callbacks: {
					title: function (tooltipItem, data) {
						times = new Set(data.datasets[0].data.map(function (e) { return e.x.toLocaleTimeString() }));
						if (times.size > 1) {
							return tooltipItem[0].xLabel;
						} else {
							return tooltipItem[0].xLabel.split('–')[0];
						}
					},
					afterLabel: function (tooltipItem, data) {
						window.total = 0;
						for (i = 0; i < data.datasets.length; i++) {
							window.total += parseFloat(data.datasets[i].data[tooltipItem.index].y)
						}
					},
					footer: function () {
						return 'Total: ' + window.total.toFixed(2);
					}
				},
			},
			scales: {
				x: {
					type: 'time',
					time: {
						tooltipFormat: 'do MMM, yyyy – h:mma',
					},
					stacked: true,
					offset: true,
				},
				y: {
					stacked: true,
					ticks: {
						beginAtZero: true,
					},
				}
			},
			hover: {
				onHover: function (e, el) {
					$('#listenerHours').css("cursor", el[0] ? "pointer" : "default");
				}
			},
			onClick: graphClickEvent,
		},
		plugins: [htmlLegendPlugin],
	});

	var browserId = document.getElementById('browser').getContext('2d');
	var browserChart = new Chart(browserId, {
		type: 'doughnut',
		data: {
			datasets: [{
				data: [],
				backgroundColor: colours,
				borderColor: colours,
			}],
			labels: []
		},
		options: {
			plugins: {
				title: {
					text: 'Browser',
				},
			},
			responsive: true,
			maintainAspectRatio: false,
		}
	});

	var countriesId = document.getElementById('countries').getContext('2d');
	var countriesChart = new Chart(countriesId, {
		type: 'bar',
		data: {
			datasets: [{
				data: [],
				backgroundColor: colours,
				borderColor: colours,
			}],
			labels: []
		},
		options: {
			plugins: {
				title: {
					text: 'Countries',
				},
			},
			legend: {
				display: false,
			},
			tooltips: {
				mode: 'label',
				callbacks: {
					title: function (tooltipItem, data) {
						return data.countries[tooltipItem[0].index];
					},
					afterLabel: function (tooltipItem, data) {
						window.percentage = parseFloat(data.datasets[0].data[tooltipItem.index]) / data.total * 100;
					},
					footer: function () {
						return window.percentage.toFixed(2) + '% of total';
					}
				},
			},
			indexAxis: 'y',
			scales: {
				x: {
					ticks: {
						beginAtZero: true,
						userCallback: function (label, index, labels) {
							if (Math.floor(label) === label) {
								return label;
							}
						},
					},
				},
			},
		}
	});

	var refererId = document.getElementById('referer').getContext('2d');
	var refererChart = new Chart(refererId, {
		type: 'bar',
		data: {
			datasets: [{
				data: [],
				backgroundColor: colours,
				borderColor: colours,
			}],
			labels: []
		},
		options: {
			plugins: {
				title: {
					text: 'Referrals',
				},
			},
			legend: {
				display: false,
			},
			indexAxis: 'y',
			tooltips: {
				mode: 'label',
				callbacks: {
					afterLabel: function (tooltipItem, data) {
						window.percentage = parseFloat(data.datasets[0].data[tooltipItem.index]) / data.total * 100;
					},
					footer: function () {
						return window.percentage.toFixed(2) + '% of total referrals';
					}
				},
			},
			scales: {
				x: {
					ticks: {
						beginAtZero: true,
						userCallback: function (label, index, labels) {
							if (Math.floor(label) === label) {
								return label;
							}
						},
					},
				},
			},
		}
	});

	var sourcesId = document.getElementById('sources').getContext('2d');
	var sourcesChart = new Chart(sourcesId, {
		type: 'line',
		options: {
			plugins: {
				title: {
					text: 'Sources',
				},
			}
		},
		scales: {
			x: {
				type: 'time',
			},
			y: {
				ticks: {
					beginAtZero: true,
				},
			}
		}
	})

	function getBrowsers(data) {
		$(browserChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/useragent/browsers/', data, function (json) {
			var data = json.results.slice(0, colours.length).map(function (e) { return e.count });
			var labels = json.results.slice(0, colours.length).map(function (e) { return e.family });
			browserChart.data.datasets[0].data = data;
			browserChart.data.labels = labels;
			browserChart.update();
			$(browserChart.canvas).parent().siblings().fadeOut('fast')
		});
	}

	function getCountries(data) {
		$(countriesChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/listener/countries/', data, function (json) {
			var data = json.results.slice(0, colours.length).map(function (e) { return e.count });
			var labels = [];
			$.each(json.results.slice(0, colours.length), function (i, result) {
				label = result.country.toUpperCase().replace(
					/./g, char => String.fromCodePoint(char.charCodeAt(0) + 127397)
				);
				labels.push(label);
			});
			// var labels = json.results.slice(0, colours.length).map(function(e) { return e.country.name });
			countriesChart.data.datasets[0].data = data;
			countriesChart.data.labels = labels;
			countriesChart.data.total = json['total'];
			var title = countriesChart.options.plugins.title.text.split(':')[0] + ': ' + parseFloat(json['distinct']);
			countriesChart.options.plugins.title.text = title;
			countriesChart.data.countries = json.results.map(function (e) { return e.name });
			countriesChart.update();
			$(countriesChart.canvas).parent().siblings().fadeOut('fast');
		});
	}

	function getReferers(data) {
		$(refererChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/listener/referer/', data, function (json) {
			var data = json.results.slice(0, colours.length).map(function (e) { return e.count });
			var labels = json.results.slice(0, colours.length).map(function (e) { return e.domain });
			refererChart.data.datasets[0].data = data;
			refererChart.data.labels = labels;
			refererChart.data.total = json['total'];
			var title = refererChart.options.plugins.title.text.split(':')[0] + ': ' + parseFloat(json['total']) + ' / Direct: ' + parseFloat(json['direct']);
			refererChart.options.plugins.title.text = title;
			refererChart.update();
			$(refererChart.canvas).parent().siblings().fadeOut('fast')
			var domains = json.results.map(function (e) { return e.domain; });
			var queryString = window.location.search;
			var urlParams = new URLSearchParams(queryString);
			var referrer = urlParams.get('referrer');
			$('#id_referrer').empty();
			$('#id_referrer').append('<option value="">---------</option>');
			$.each(domains.sort(), function (index, domain) {
				if (domain == referrer) {
					$('#id_referrer').append('<option value=' + referrer + ' selected>' + referrer + '</option>');
				} else {
					$('#id_referrer').append('<option value=' + domain + '>' + domain + '</option>');
				}
			});
		});
	}

	function getSources(data) {
		$(sourcesChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/source/connections/', data, function (json) {
			$.each(json.results, function (index, stream) {
				json.results[index].borderColor = colours[index];
				json.results[index].stepped = true;
			})
			console.log(json.results);
			sourcesChart.data.datasets = json.results;
			sourcesChart.update();
			$(sourcesChart.canvas).parent().siblings().fadeOut('fast');
		});
	}

	function updateTitle(chart) {
		var total = 0;

		$.each(chart.data.datasets, function (e, dataset) {
			if (chart.isDatasetVisible(e)) {
				if (chart.canvas.id === 'listenerCount') {
					total += countTotals.filter(function (e) {
						return e.stream === dataset.label
					})[0].count
				} else {
					total += parseFloat(dataset.data.map(function (e) {
						return e.y
					}).reduce(function (total, num) {
						return parseFloat(total) + parseFloat(num);
					}))
				}
			}
		});

		var title = chart.options.plugins.title.text.split(':')[0] + ': ' + parseFloat(total.toFixed(2));
		chart.options.plugins.title.text = title
		chart.update();
	}

	function parseVerticalBarChartData(chart, json) {
		var datasets = [];
		var streams = Array.from(new Set(json.results.map(function (e) { return e['stream'] })));
		var periods = Array.from(new Set(json.results.map(function (e) { return e['period'] })));

		$.each(streams, function (stream_index, stream) {
			var data = [];
			$.each(periods, function (period_index, period) {
				data.push({
					x: new Date(period),
					y: json.results.filter(function (e) {
						return e.stream === stream && e.period === period
					}).map(function (e) {
						return e.count
					})[0] || 0
				})
			});
			datasets.push({
				label: stream,
				backgroundColor: colours[stream_index],
				borderColor: colours[stream_index],
				data: data,
			})
		})

		chart.data.datasets = datasets;
		chart.update();
		updateTitle(chart);
		$(chart.canvas).parent().siblings().fadeOut('fast')
	}

	function getCount(data) {
		$(listenerCountChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/listener/count/', data, function (json) {
			countTotals = json.totals;
			parseVerticalBarChartData(listenerCountChart, json);

			var start = moment(json.period.start).format('YYYY/MM/DD HH');
			var end = moment(json.period.end).format('YYYY/MM/DD HH');
			$('#id_datepicker').data('daterangepicker').setStartDate(start);
			$('#id_datepicker').data('daterangepicker').setEndDate(end);

			// var legendContainer = document.getElementById("legend");
			// // legendContainer.innerHTML = listenerCountChart.generateLegend();
			// var legendItems = legendContainer.getElementsByTagName('li');
			// for (var i = 0; i < legendItems.length; i += 1) {
			// 	legendItems[i].addEventListener("click", legendClickCallback, false);
			// }
			$(listenerCountChart.canvas).parent().siblings().fadeOut('fast')
		});
	}

	function getCount2(data) {
		$.get('/listener/count2/', data, function (json) {
			var countDatasets = [];
			var streams = json.totals.map(function (e) { return e.stream });

			$.each(streams, function (stream_index, stream) {
				var count_data = [];

				$.each(json.results, function (result) {
					$.each(json.results[result], function (i, e) {
						if (e['stream'] === stream) {
							count_data.push({
								x: new Date(result),
								y: e['count'],
							})
						}
					})
				});

				countDatasets.push({
					label: stream,
					backgroundColor: colours[stream_index],
					borderColor: colours[stream_index],
					data: count_data,
				})
			});

			listenerCountChart.data.datasets = countDatasets;
			listenerCountChart.update();

			var start = moment(json.results[0].period).format('YYYY/MM/DD HH');
			var end = moment(json.results[json.results.length - 1].period).format('YYYY/MM/DD HH');
			$('#id_datepicker').data('daterangepicker').setStartDate(start);
			$('#id_datepicker').data('daterangepicker').setEndDate(end);
		});
	}

	function getHours(data) {
		$(listenerHoursChart.canvas).parent().siblings().fadeIn('fast')
		$.get('/listener/hours/', data, function (json) {
			parseVerticalBarChartData(listenerHoursChart, json);
		});
	}

	function getLiveListeners() {
		$.get('/live/', function (json) {
			$('#live').html('<ul></ul>');
			$.each(json, function (station, listeners) {
				$('#live').find('ul').append('<li>' + station + ': ' + listeners + '</li>');
			})
		});
	}

	function getData(params) {
		if (!(params)) {
			params = $("form *:not([class=exclude]").filter(function (index, element) {
				return $(element).val() != '';
			}).serialize();
		}
		window.history.pushState("object or string", "Title", "?" + params)

		getCount(params);
		getHours(params);
		getBrowsers(params);
		getCountries(params);
		getReferers(params);
		getSources(params);
	}

	function timeSlotsPopulated() {
		var nonEmptyItems = $('input[id^="id_slot_"]').filter(function () {
			return this.value != '';
		})
		if (nonEmptyItems.length == 2) {
			return true;
		}
	}

	$(document).ready(function () {
		$('#id_dow').change(function () {
			if ($(this).val() == '') {
				$('input[id^="id_timepicker"').val('');
				$('input[id^="id_slot"').val('');
				$('#id_dom, input[name^="timepicker"').prop('disabled', true).closest('.cell').addClass('disabled');
				getData();
			} else {
				$('#id_dom, input[name^="timepicker"').prop('disabled', false).closest('.cell').removeClass('disabled');
				if (timeSlotsPopulated()) { getData(); }
			}
		}).change();
		$('#id_dom').change(function () {
			$('#id_dow span').toggle($(this).val() > 0);
			if (timeSlotsPopulated()) { getData(); }
		}).change();
		var params = window.location.search.substr(1);
		getData(params);
		getLiveListeners();
		setInterval(function () { getLiveListeners(); }, 30000);
	});

	$('input[name^="timepicker"]').on('apply.daterangepicker', function () {
		$('#' + this.id.replace('timepicker', 'slot')).val(this.value);
		if (timeSlotsPopulated()) { getData(); }
	});
	$('#id_station, #id_region, #id_referrer').change(function () {
		getData();
	});

	$('#restart').on('click', function (e) {
		if (confirm("Are you sure you want to restart the streams? This will kick all the listeners off and they will need to reconnect!")) {
			$.ajax({
				url: '/restart/',
				method: 'POST',
				data: {
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			});
		}
	});
</script>

{% endblock %}